{"version":3,"sources":["../tmp/transpiled/membrane.js"],"names":[],"mappings":"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","file":"membrane.js","sourcesContent":["define(\"MJS/membrane\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n\n    var MJS = {};\n\n    var log = function(msg) {\n      if (console)\n        console.log(msg);\n      if (typeof $ !== 'undefined')\n        $('.log').prepend(msg+'<br>');\n    };\n\n    var MSystem = function(params) {\n      _.assign(this, {\n        membrane: null,\n        world: {}\n      }, params);\n    };\n    MSystem.prototype.simulate = function(stepLimit) {\n      var outCome = true;\n      stepLimit = stepLimit || 100;\n      MJS.log('simulating');\n      for (var i=0; i<stepLimit && outCome; ++i) {\n        MJS.log('- step: '+(i+1));\n        MJS.log('system world before: '+this.toString());\n        outCome = this.membrane.step(this.world);\n        if (outCome.dissolved)\n          throw 'Error: Outermost membrane dissolved';\n        MJS.log('system world after: '+this.toString());\n      }\n      MJS.log('finished');\n    };\n    MSystem.prototype.toString = function() {\n      return this.worldToString() +' '+ this.membrane.toString();\n    };\n    MSystem.prototype.worldToString = function () {\n      return setToString(this.world);\n    };\n\n    var Rule = function(params) {\n      _.assign(this, {\n        type: Rule.Type.EVOLVE,\n        reactants: {},\n        products: {},\n        charge: null,\n        label: null\n      }, params);\n    };\n\n    var idCounter = 0;\n\n    var Membrane = function(params) {\n      _.assign(this, {\n        // array of Rules\n        rules: [],\n        // set of object definitions symbol:count\n        world: {},\n        // children Membranes\n        membranes: [],\n        label: null,\n        charge: null\n      }, params);\n      this.id = ++idCounter;\n    };\n    /**\n     * Simulates a single step for the membrane and its inner membranes\n     * @param  {object} externalWorld A world object set\n     * @return {bool/object} true if a rule was applied, false otherwise, {dissolved: true} if dissolved\n     */\n    Membrane.prototype.step = function(externalWorld) {\n      var self = this,\n          anyRulesApplied = false,\n          hasDissolved = false;\n\n      // Step inner membranes first\n      for (var i = 0; i < this.membranes.length; ++i) {\n        var membrane = this.membranes[i];\n        var result = membrane.step(self.world);\n        if (result.dissolved) {\n          MJS.log('dissolving '+membrane.id);\n          this.membranes.splice(i--, 1);\n        }\n        if (result) {\n          anyRulesApplied = true;\n        }\n      }\n\n      // Get all the rules that can apply\n      var applicableRules = [];\n      _.forEach(this.rules, function(rule) {\n        _.times(rule.numberApplications(self.world), function() {\n          applicableRules.push(rule);\n        });\n      });\n\n      MJS.log('membrane before: '+this.toString());\n\n      // Apply rules in random order and skip those that no longer apply\n      shuffle(applicableRules);\n      var oldWorld = _.cloneDeep(this.world);\n      _.forEach(applicableRules, function(rule) {\n        var result = rule.applyRule(oldWorld, self.world);\n        if (_.isObject(result)) {\n          _.forEach(result, function(count, symbol) {\n            if (typeof externalWorld[symbol] === 'undefined')\n              externalWorld[symbol] = 0;\n            externalWorld[symbol]+=count;\n          });\n        }\n        if (result) {\n          anyRulesApplied = true;\n          if (rule.type === Rule.Type.DISSOLVE) {\n            hasDissolved = true;\n            return false;\n          }\n        }\n      });\n\n      MJS.log('membrane after: '+this.toString());\n\n      if (hasDissolved)\n        return {dissolved: true};\n      return anyRulesApplied;\n    };\n    Membrane.prototype.toString = function() {\n      var world = this.worldToString();\n      var children = '';\n      _.forEach(this.membranes, function(membrane) {\n        children+=membrane.toString();\n      });\n      return '('+this.id+')['+(world.slice(1,world.length-1))+children+']';\n    };\n    Membrane.prototype.worldToString = function () {\n      return setToString(this.world);\n    };\n\n    var Rule = function(params) {\n      _.assign(this, {\n        type: Rule.Type.EVOLVE,\n        // symbols consumed by the rule\n        reactants: {},\n        // symbols generated by the rule\n        products: {},\n        charge: null,\n        label: null\n      }, params);\n    };\n    Rule.prototype.numberApplications = function(world) {\n      var self = this,\n          num = 0,\n          tempWorld = _.cloneDeep(world),\n          applied;\n      do {\n        applied = this.applyRule(tempWorld);\n        if (applied) {\n          num+=1;\n        }\n      } while(applied);\n      return num;\n    };\n    /**\n     * Apply the rule to the given world. Only updates the world\n     * if it can actually apply the rule\n     * @param  {object} oldWorld {symbol:count,...} world to decrement but not add to\n     * @param  {object} world {symbol:count,...} (optional) world to both decrement and add to\n     * @return {bool/object} Whether the rule was applied or not, or world set object if sending out\n     */\n    Rule.prototype.applyRule = function(oldWorld, world) {\n      var self = this,\n          applied = true,\n          sendOutSet = {};\n\n      // First preprocess to check if all rules can apply\n      _.forEach(self.reactants, function(count, symbol) {\n        if (typeof oldWorld[symbol] === 'undefined' || oldWorld[symbol] < count) {\n          applied = false;\n          return false;\n        }\n      });\n\n      // Then apply them all if possible\n      if (applied) {\n        _.forEach(self.reactants, function(count, symbol) {\n          oldWorld[symbol]-= count;\n          if (world)\n            world[symbol]-= count;\n        });\n\n        if (world)\n          MJS.log('apply rule: '+this.toString());\n\n        _.forEach(self.products, function(count, symbol) {\n          var w = world;\n          if (self.type === Rule.Type.SEND_OUT ||\n              self.type === Rule.Type.DISSOLVE)\n          {\n            w = sendOutSet;\n          }\n\n          if (w && typeof w[symbol] === 'undefined')\n            w[symbol] = 0;\n          if (w)\n            w[symbol]+=count;\n        });\n      }\n\n      if (_.keys(sendOutSet).length) {\n        return sendOutSet;\n      }\n      return applied;\n    };\n    Rule.prototype.toString = function() {\n      return \"Rule(\"+this.type+\") react\"+setToString(this.reactants)+' prod'+setToString(this.products);\n    };\n\n    Rule.Type = {\n      EVOLVE: 'evolve',\n      SEND_OUT: 'sendOut',\n      DISSOLVE: 'dissolve',\n      // TODO other rule types\n      //SEND_IN: 'sendIn',\n      //ELEMENTARY_DIVISION: 'elementaryDivision',\n      //NONELEMENTARY_DIVIONS: 'nonelementaryDivision'\n    };\n\n    //+ Jonas Raoni Soares Silva\n    //@ http://jsfromhell.com/array/shuffle [v1.0]\n    function shuffle(o){ //v1.0\n      for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);\n      return o;\n    }\n\n    /**\n     * @param {[type]} set {symbol:count,...}\n     */\n    function setToString(set) {\n      var chars = ['['];\n      _.forEach(set, function(count, symbol) {\n        _.times(count, function(){\n          chars.push(symbol);\n        });\n      });\n      chars.push(']');\n      return chars.join(' ');\n    }\n\n    MJS.log = log;\n    MJS.MSystem = MSystem;\n    MJS.Membrane = Membrane;\n    MJS.Rule = Rule;\n    __exports__[\"default\"] = MJS;\n  });"]}